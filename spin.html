<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Spin Wheel - SorcerorHc</title>
<style>
  :root {
    --bg: #05060a;
    --panel: #0b1220;
    --accent1: #0ea5ff;
    --accent2: #3b82f6;
    --text-light: #e6eef8;
    --highlight: #ef4444;
  }
  body {
    margin: 0;
    background: var(--bg);
    color: var(--text-light);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 1rem;
  }
  header {
    width: 100%;
    display: flex;
    justify-content: space-between;
    margin-bottom: 1rem;
    font-weight: 700;
    font-size: 1.2rem;
  }
  #limitSpin {
    background: var(--panel);
    padding: 0.4rem 0.8rem;
    border-radius: 6px;
  }
  #sorcerorName {
    background: var(--panel);
    padding: 0.4rem 0.8rem;
    border-radius: 6px;
  }
  #wheel-container {
    margin: 0 auto;
    position: relative;
    width: 400px;
    height: 400px;
    border-radius: 50%;
    overflow: visible;
    background: var(--panel);
    box-shadow: 0 0 15px var(--accent2);
  }
  #wheel {
    width: 100%;
    height: 100%;
    cursor: pointer;
    border-radius: 50%;
    user-select: none;
  }
  #spinBtn {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    padding: 1rem 3rem;
    font-size: 1.3rem;
    font-weight: 700;
    border-radius: 50px;
    border: none;
    background: var(--accent1);
    color: #012033;
    cursor: pointer;
    user-select: none;
    transition: background 0.3s ease;
    z-index: 20;
  }
  #spinBtn:disabled {
    background: #555;
    cursor: not-allowed;
  }
  #resultText {
    margin-top: 1rem;
    font-size: 1.2rem;
    font-weight: 600;
    min-height: 1.5em;
    text-align: center;
  }

  /* Panah atas menghadap ke bawah */
  #pointerTop {
    position: absolute;
    top: -40px;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 25px solid transparent;
    border-right: 25px solid transparent;
    border-top: 40px solid var(--highlight);
    z-index: 10;
  }

  @media (max-width: 480px) {
    #wheel-container {
      width: 320px;
      height: 320px;
    }
    #spinBtn {
      padding: 0.8rem 2.5rem;
      font-size: 1.1rem;
    }
  }
</style>
</head>
<body>

<header>
  <div id="limitSpin" aria-live="polite">Limit Spin: 0</div>
  <div id="sorcerorName">SorcerorHc</div>
</header>

<div id="wheel-container" role="region" aria-label="Spin Wheel">
  <div id="pointerTop" aria-hidden="true"></div>
  <canvas id="wheel" width="400" height="400" aria-label="Roda hadiah"></canvas>
  <button id="spinBtn" aria-label="Tombol Spin">Spin</button>
</div>

<div id="resultText" role="alert" aria-live="assertive"></div>

<script>
  const DB_KEY = 'spin_db_v2';
  const currentUserRaw = localStorage.getItem('spin_current_user');
  if (!currentUserRaw) {
    alert('Silakan login terlebih dahulu.');
    window.location.href = 'index.html';
  }
  const currentUser = JSON.parse(currentUserRaw);

  const dbRaw = localStorage.getItem(DB_KEY);
  const db = dbRaw ? JSON.parse(dbRaw) : { users: [], prizes: [] };

  const user = db.users.find(u => u.username === currentUser.username);
  if (!user) {
    alert('User tidak ditemukan. Silakan hubungi owner.');
    window.location.href = 'index.html';
  }

  const limitSpinEl = document.getElementById('limitSpin');
  const spinBtn = document.getElementById('spinBtn');
  const resultText = document.getElementById('resultText');
  const wheelCanvas = document.getElementById('wheel');
  const ctx = wheelCanvas.getContext('2d');

  function updateLimitSpin() {
    limitSpinEl.textContent = `Limit Spin: ${user.spinLimit || 0}`;
    spinBtn.disabled = (user.spinLimit || 0) <= 0;
  }
  updateLimitSpin();

  const prizes = db.prizes.length ? db.prizes : [
    { name: "Hadiah Default A", chance: 50 },
    { name: "Hadiah Default B", chance: 30 },
    { name: "Hadiah Default C", chance: 20 },
  ];

  const totalChance = prizes.reduce((sum, p) => sum + p.chance, 0);
  const segments = prizes.map(p => p.name);
  const chances = prizes.map(p => p.chance);

  const segmentColors = ['#0ea5ff', '#3b82f6', '#2563eb', '#60a5fa', '#93c5fd', '#bfdbfe'];

  const centerX = wheelCanvas.width / 2;
  const centerY = wheelCanvas.height / 2;
  const radius = wheelCanvas.width / 2 - 30;

  function drawWheel() {
    let startAngle = 0;
    ctx.clearRect(0, 0, wheelCanvas.width, wheelCanvas.height);
    for (let i = 0; i < segments.length; i++) {
      const segmentAngle = (chances[i] / totalChance) * 2 * Math.PI;
      ctx.beginPath();
      ctx.moveTo(centerX, centerY);
      ctx.arc(centerX, centerY, radius, startAngle, startAngle + segmentAngle);
      ctx.fillStyle = segmentColors[i % segmentColors.length];
      ctx.fill();
      ctx.strokeStyle = '#00000088';
      ctx.lineWidth = 1;
      ctx.stroke();

      ctx.save();
      ctx.translate(centerX, centerY);
      ctx.rotate(startAngle + segmentAngle / 2);

      // Rotate text 90 degrees downward (miring ke bawah)
      ctx.rotate(Math.PI / 2);

      const textRadius = radius + 25;

      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.font = 'bold 16px Arial';

      const text = segments[i];
      const textWidth = ctx.measureText(text).width;
      const padding = 5;

      ctx.fillStyle = 'rgba(0, 0, 0, 0.6)';
      ctx.fillRect(-textWidth/2 - padding, textRadius - 14, textWidth + padding*2, 28);

      ctx.fillStyle = '#fff';
      ctx.fillText(text, 0, textRadius);

      ctx.restore();
      startAngle += segmentAngle;
    }
  }

  drawWheel();

  let isSpinning = false;
  let currentRotation = 0;

  spinBtn.addEventListener('click', () => {
    if (isSpinning || (user.spinLimit || 0) <= 0) return;

    isSpinning = true;
    spinBtn.disabled = true;
    resultText.textContent = '';

    // Reset rotasi ke 0 dulu sebelum spin baru
    wheelCanvas.style.transition = 'transform 0.5s ease-out';
    wheelCanvas.style.transform = `rotate(0deg)`;

    setTimeout(() => {
      const rand = Math.random() * totalChance;
      let sum = 0;
      let selectedIndex = 0;
      for (let i = 0; i < prizes.length; i++) {
        sum += prizes[i].chance;
        if (rand <= sum) {
          selectedIndex = i;
          break;
        }
      }

      let anglePerSegment = (chances[selectedIndex] / totalChance) * 360;
      let accumulatedAngle = 0;
      for (let i = 0; i < selectedIndex; i++) {
        accumulatedAngle += (chances[i] / totalChance) * 360;
      }
      const offsetAngle = Math.random() * anglePerSegment;

      const spins = 5;
      const finalRotation = spins * 360 + (360 - (accumulatedAngle + offsetAngle));

      wheelCanvas.style.transition = 'transform 5s cubic-bezier(0.33, 1, 0.68, 1)';
      wheelCanvas.style.transform = `rotate(${finalRotation}deg)`;

      setTimeout(() => {
        currentRotation = finalRotation % 360;

        user.spinLimit = (user.spinLimit || 0) - 1;
        user.lastPrize = prizes[selectedIndex].name;

        resultText.textContent = `Selamat! Anda mendapatkan: ${user.lastPrize}`;
        updateLimitSpin();

        const userIndex = db.users.findIndex(u => u.username === user.username);
        if (userIndex !== -1) {
          db.users[userIndex] = user;
          localStorage.setItem(DB_KEY, JSON.stringify(db));
        }

        isSpinning = false;
        spinBtn.disabled = user.spinLimit <= 0;
      }, 5000);
    }, 600);
  });
</script>

</body>
</html>
